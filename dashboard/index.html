<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AutoCodex Dashboard</title>
    <style>
      :root {
        --bg: #0b0614;
        --panel: #1a0f2e;
        --panel-2: #24143f;
        --ink: #f2eaff;
        --muted: #c7a9ff;
        --accent: #28f0ff;
        --accent-2: #ff2d9a;
        --warning: #ffd166;
        --border: #3a1f6f;
        --shadow: rgba(7, 3, 18, 0.75);
        --radius: 18px;
        --mono: "JetBrains Mono", "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
        --sans: "Rajdhani", "Space Grotesk", "IBM Plex Sans", "Segoe UI", sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--ink);
        background:
          radial-gradient(circle at 20% 10%, rgba(255, 45, 154, 0.25), transparent 45%),
          radial-gradient(circle at 80% 15%, rgba(125, 255, 251, 0.2), transparent 40%),
          radial-gradient(circle at 50% 80%, rgba(128, 64, 255, 0.35), transparent 55%),
          linear-gradient(180deg, #0a0615 0%, #12091f 55%, #090513 100%);
        min-height: 100vh;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background:
          linear-gradient(90deg, rgba(255, 45, 154, 0.08), transparent 35%),
          repeating-linear-gradient(
            120deg,
            rgba(255, 45, 154, 0.06) 0px,
            rgba(255, 45, 154, 0.06) 1px,
            transparent 1px,
            transparent 6px
          );
        mix-blend-mode: screen;
        pointer-events: none;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 32px 8px;
      }

      .title {
        font-size: 32px;
        font-weight: 600;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        text-shadow: 0 0 14px rgba(40, 240, 255, 0.6);
      }

      .subtitle {
        color: var(--muted);
        font-size: 15px;
        margin-top: 4px;
      }

      .shell {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 20px;
        padding: 0 32px 32px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: 0 16px 36px var(--shadow);
      }

      .side {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .side h3 {
        margin: 0;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--muted);
      }

      .project-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .project {
        padding: 10px 12px;
        border-radius: 12px;
        background: var(--panel-2);
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
      }

      .project.active {
        border-color: var(--accent);
        box-shadow: inset 0 0 0 1px rgba(40, 240, 255, 0.45);
      }

      .project:hover {
        border-color: rgba(40, 240, 255, 0.6);
      }

      .main {
        padding: 16px;
        display: grid;
        grid-template-rows: auto auto 1fr;
        gap: 16px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(5, minmax(140px, 1fr));
        gap: 12px;
      }

      .card {
        padding: 14px;
        background: var(--panel-2);
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .card h4 {
        margin: 0 0 8px;
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .card .value {
        font-size: 22px;
        font-weight: 600;
        text-shadow: 0 0 10px rgba(40, 240, 255, 0.35);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(40, 240, 255, 0.18);
        color: var(--accent);
        font-size: 13px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 16px;
      }

      .grid.top-grid {
        grid-template-columns: 1.2fr 1fr;
        align-items: stretch;
      }

      .stack {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .section {
        padding: 16px;
        background: var(--panel-2);
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .section h3 {
        margin: 0 0 12px;
        font-size: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--muted);
      }

      .intake-box {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .intake-box textarea {
        width: 100%;
        min-height: 140px;
        background: #0f0a1f;
        color: var(--ink);
        border: 1px solid rgba(58, 31, 111, 0.9);
        border-radius: 10px;
        padding: 10px;
        font-family: var(--mono);
        font-size: 13px;
        line-height: 1.5;
      }

      #interactionNotes {
        width: 100%;
        min-height: 140px;
        background: #0f0a1f;
        color: var(--ink);
        border: 1px solid rgba(58, 31, 111, 0.9);
        border-radius: 10px;
        padding: 10px;
        font-family: var(--mono);
        font-size: 13px;
        line-height: 1.5;
      }

      .intake-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .tasks {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 260px;
        overflow: auto;
        padding-right: 4px;
      }

      .task {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(20, 10, 40, 0.7);
        border: 1px solid rgba(58, 31, 111, 0.8);
      }

      .task .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .task .icon {
        width: 18px;
        height: 18px;
        border-radius: 6px;
        border: 1px solid rgba(58, 31, 111, 0.9);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--muted);
        background: rgba(12, 6, 24, 0.7);
      }

      .task.todo .icon::before {
        content: "";
      }

      .task.done .icon {
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 12px rgba(40, 240, 255, 0.35);
      }

      .task.done .icon::before {
        content: "✓";
      }

      .task.blocked .icon,
      .task.failed .icon {
        border-color: #ff5c7a;
        color: #ff5c7a;
        box-shadow: 0 0 12px rgba(255, 92, 122, 0.35);
      }

      .task.blocked .icon::before,
      .task.failed .icon::before {
        content: "✕";
      }

      .task .name {
        font-size: 13px;
      }

      .task .status {
        display: none;
      }

      .log {
        font-family: var(--mono);
        font-size: 13px;
        line-height: 1.5;
        background: #0f0a1f;
        border-radius: 12px;
        border: 1px solid rgba(58, 31, 111, 0.9);
        padding: 12px;
        height: 320px;
        overflow: auto;
        white-space: pre-wrap;
      }

      .review-content {
        font-family: var(--mono);
        font-size: 13px;
        line-height: 1.5;
        background: #0f0a1f;
        border-radius: 12px;
        border: 1px solid rgba(58, 31, 111, 0.9);
        padding: 12px;
        height: 220px;
        overflow: auto;
        white-space: pre-wrap;
      }

      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 12px;
        color: var(--muted);
      }

      .interaction-panel {
        position: relative;
        overflow: hidden;
        background:
          linear-gradient(135deg, rgba(40, 240, 255, 0.08), transparent 60%),
          rgba(26, 15, 46, 0.9);
      }

      .interaction-panel::after {
        content: "";
        position: absolute;
        inset: 0;
        border: 1px solid rgba(40, 240, 255, 0.25);
        border-radius: 12px;
        box-shadow: inset 0 0 18px rgba(40, 240, 255, 0.12);
        pointer-events: none;
      }

      .interaction-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }

      .interaction-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(40, 240, 255, 0.45);
        color: var(--accent);
        font-size: 12px;
      }

      .btn {
        background: var(--accent);
        color: #120515;
        border: none;
        padding: 8px 12px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 0 16px rgba(40, 240, 255, 0.55);
      }

      .btn.alt {
        background: transparent;
        color: var(--ink);
        border: 1px solid var(--border);
      }

      .tabs {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 12px;
      }

      .tab {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--muted);
        padding: 8px 14px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.8px;
        text-transform: uppercase;
      }

      .tab.active {
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 16px rgba(40, 240, 255, 0.45);
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      @keyframes glowIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .panel, .section {
        animation: glowIn 0.4s ease-out;
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      .switch {
        gap: 10px;
      }

      .switch input {
        display: none;
      }

      .switch .slider {
        position: relative;
        width: 44px;
        height: 22px;
        background: rgba(36, 20, 63, 0.9);
        border: 1px solid var(--border);
        border-radius: 999px;
        transition: all 0.2s ease;
        box-shadow: inset 0 0 12px rgba(40, 240, 255, 0.2);
      }

      .switch .slider::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: var(--accent);
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(40, 240, 255, 0.6);
        transition: all 0.2s ease;
      }

      .switch input:checked + .slider {
        background: rgba(40, 240, 255, 0.25);
        border-color: var(--accent);
        box-shadow: 0 0 14px rgba(40, 240, 255, 0.35);
      }

      .switch input:checked + .slider::after {
        transform: translateX(22px);
      }

      @media (max-width: 900px) {
        .shell {
          grid-template-columns: 1fr;
        }
        .cards {
          grid-template-columns: repeat(2, minmax(140px, 1fr));
        }
        .grid {
          grid-template-columns: 1fr;
        }
        .intake-box {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <div class="title" data-i18n="title">AutoCodex Monitor</div>
        <div class="subtitle" data-i18n="subtitle">Local project status, tasks, and logs in one view.</div>
      </div>
      <div class="controls">
        <label class="toggle">
          <span data-i18n="languageLabel">Language</span>
          <select id="languageSelect" class="btn alt" style="padding: 6px 10px;">
            <option value="zh">中文</option>
            <option value="en">English</option>
          </select>
        </label>
        <span id="lastUpdated">Last update: --</span>
        <label class="toggle">
          <input type="checkbox" id="followLogs" checked />
          <span data-i18n="followLogs">Follow logs</span>
        </label>
        <button class="btn alt" id="refreshBtn" data-i18n="refresh">Refresh</button>
      </div>
    </header>

    <div class="shell">
      <aside class="panel side">
        <h3 data-i18n="projects">Projects</h3>
        <div id="projectList" class="project-list"></div>
      </aside>

      <main class="panel main">
        <div class="cards">
          <div class="card">
            <h4 data-i18n="state">State</h4>
            <div class="value" id="stateValue">--</div>
          </div>
          <div class="card">
            <h4 data-i18n="role">Role</h4>
            <div class="value" id="roleValue">--</div>
          </div>
          <div class="card">
            <h4 data-i18n="runtime">Runtime</h4>
            <div class="value" id="runtimeValue">--</div>
          </div>
          <div class="card">
            <h4 data-i18n="heartbeat">Heartbeat Age</h4>
            <div class="value" id="heartbeatValue">--</div>
          </div>
          <div class="card">
            <h4 data-i18n="successRate">Success Rate</h4>
            <div class="value" id="successValue">--</div>
          </div>
        </div>

        <div class="section">
          <div class="badge" id="taskBadge">Tasks: --</div>
          <div class="badge" id="diagnosisBadge">Diagnosis: --</div>
        </div>

        <div class="section">
          <div class="tabs">
            <button class="tab active" data-tab="mainTab" data-i18n="tabMain">Main</button>
            <button class="tab" data-tab="reviewTab" data-i18n="tabReview">Review</button>
          </div>
          <div id="mainTab" class="tab-panel active">
            <div class="grid top-grid">
              <div class="section">
                <h3 data-i18n="taskList">Task List</h3>
                <div class="tasks" id="taskList"></div>
              </div>
              <div class="section">
                <h3 data-i18n="latestLog">Latest Log Tail</h3>
                <div class="log" id="logBox">No logs.</div>
              </div>
            </div>
            <div class="grid" style="margin-top: 18px;">
              <div class="section interaction-panel">
                <div class="interaction-header">
                  <h3 data-i18n="interaction">Interaction</h3>
                  <span class="interaction-pill" id="interactionState">State: --</span>
                </div>
                <div class="controls" style="margin-bottom: 8px;">
                  <label class="toggle switch">
                    <input type="checkbox" id="interactiveModeToggle" />
                    <span class="slider"></span>
                    <span data-i18n="interactiveMode">Interactive Mode</span>
                  </label>
                </div>
                <textarea id="interactionNotes" placeholder="Type notes for the agent here." data-i18n-placeholder="interactionPlaceholder"></textarea>
                <div class="intake-actions">
                  <button class="btn" id="saveInteractionBtn" data-i18n="saveNotes">Save Notes</button>
                  <button class="btn alt" id="interruptBtn" data-i18n="interruptNow">Interrupt Now</button>
                  <button class="btn alt" id="continueBtn" data-i18n="continue">Continue</button>
                </div>
              </div>
              <div class="section">
                <h3 data-i18n="intake">Intake</h3>
                <div class="intake-box">
                  <textarea id="intakeQuestions" readonly placeholder="Questions will appear here." data-i18n-placeholder="intakeQuestionsPlaceholder"></textarea>
                  <textarea id="intakeAnswers" placeholder="Write your answers here." data-i18n-placeholder="intakeAnswersPlaceholder"></textarea>
                </div>
                <div class="intake-actions">
                  <button class="btn" id="saveIntakeBtn" data-i18n="saveAnswers">Save Answers</button>
                  <button class="btn alt" id="resumeBtn" data-i18n="resumeIntake">Resume Intake</button>
                  <button class="btn alt" id="pauseBtn" data-i18n="pauseProject">Pause Project</button>
                  <button class="btn alt" id="runBtn" data-i18n="runTick">Run Tick</button>
                </div>
              </div>
            </div>
          </div>
          <div id="reviewTab" class="tab-panel">
            <h3 data-i18n="review">Review</h3>
            <div class="subtitle" id="reviewHint">No review pending.</div>
            <div class="tasks" id="reviewList"></div>
            <div class="intake-actions">
              <button class="btn alt" id="continueAfterReviewBtn" data-i18n="continueAfterReview">Continue After Review</button>
            </div>
            <div class="section" style="margin-top: 16px;">
              <h3 data-i18n="reviewContent">Review Content</h3>
              <div class="review-content" id="reviewContent">Select a file to preview.</div>
            </div>
          </div>
        </div>

        
      </main>
    </div>

    <script>
      const projectListEl = document.getElementById("projectList");
      const stateValue = document.getElementById("stateValue");
      const roleValue = document.getElementById("roleValue");
      const runtimeValue = document.getElementById("runtimeValue");
      const heartbeatValue = document.getElementById("heartbeatValue");
      const taskBadge = document.getElementById("taskBadge");
      const diagnosisBadge = document.getElementById("diagnosisBadge");
      const taskList = document.getElementById("taskList");
      const eventList = document.getElementById("eventList");
      const logBox = document.getElementById("logBox");
      const lastUpdated = document.getElementById("lastUpdated");
      const refreshBtn = document.getElementById("refreshBtn");
      const successValue = document.getElementById("successValue");
      const intakeQuestions = document.getElementById("intakeQuestions");
      const intakeAnswers = document.getElementById("intakeAnswers");
      const saveIntakeBtn = document.getElementById("saveIntakeBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const resumeBtn = document.getElementById("resumeBtn");
      const runBtn = document.getElementById("runBtn");
      const followLogs = document.getElementById("followLogs");
      const reviewList = document.getElementById("reviewList");
      const reviewHint = document.getElementById("reviewHint");
      const continueAfterReviewBtn = document.getElementById("continueAfterReviewBtn");
      const reviewContent = document.getElementById("reviewContent");
      const interactionNotes = document.getElementById("interactionNotes");
      const interactiveModeToggle = document.getElementById("interactiveModeToggle");
      const saveInteractionBtn = document.getElementById("saveInteractionBtn");
      const interruptBtn = document.getElementById("interruptBtn");
      const continueBtn = document.getElementById("continueBtn");
      const interactionState = document.getElementById("interactionState");
      const tabs = document.querySelectorAll(".tab");
      const tabPanels = document.querySelectorAll(".tab-panel");
      const languageSelect = document.getElementById("languageSelect");

      let currentProject = null;
      let timer = null;
      let intakeDirty = false;
      let interactionDirty = false;
      let lastLogKey = "";
      let currentLang = "zh";

      const LANG = {
        zh: {
          title: "AutoCodex Monitor",
          subtitle: "本地项目状态、任务与日志一站式查看。",
          languageLabel: "语言",
          followLogs: "跟随日志",
          refresh: "刷新",
          projects: "项目",
          state: "状态",
          role: "角色",
          runtime: "运行时长",
          heartbeat: "心跳时长",
          successRate: "成功率",
          tabMain: "主面板",
          tabReview: "审阅",
          interaction: "交互",
          interactiveMode: "交互模式",
          interactionPlaceholder: "在此输入给智能体的提示/说明。",
          saveNotes: "保存说明",
          interruptNow: "立即打断",
          continue: "继续",
          intake: "需求采集",
          intakeQuestionsPlaceholder: "问题将在这里显示。",
          intakeAnswersPlaceholder: "请在此填写你的回答。",
          saveAnswers: "保存回答",
          resumeIntake: "继续采集",
          pauseProject: "暂停项目",
          runTick: "运行 Tick",
          taskList: "任务列表",
          recentEvents: "近期事件",
          latestLog: "最新日志",
          review: "审阅",
          continueAfterReview: "审阅完成后继续",
          reviewContent: "审阅内容",
          noLogs: "暂无日志。",
          reviewHintNone: "当前无需审阅。",
          reviewHintNeed: "需要审阅：点击文件预览，完成后点击继续。",
          stateLabel: "状态",
          tasksLabel: "任务",
          diagnosisLabel: "诊断",
          lastUpdated: "最近更新",
          interactionState: "状态",
          reviewSelectPrompt: "请选择文件预览。",
          statusTodo: "未完成",
          statusDone: "完成",
          statusBlocked: "阻塞",
          statusFailed: "失败",
        },
        en: {
          title: "AutoCodex Monitor",
          subtitle: "Local project status, tasks, and logs in one view.",
          languageLabel: "Language",
          followLogs: "Follow logs",
          refresh: "Refresh",
          projects: "Projects",
          state: "State",
          role: "Role",
          runtime: "Runtime",
          heartbeat: "Heartbeat Age",
          successRate: "Success Rate",
          tabMain: "Main",
          tabReview: "Review",
          interaction: "Interaction",
          interactiveMode: "Interactive Mode",
          interactionPlaceholder: "Type notes for the agent here.",
          saveNotes: "Save Notes",
          interruptNow: "Interrupt Now",
          continue: "Continue",
          intake: "Intake",
          intakeQuestionsPlaceholder: "Questions will appear here.",
          intakeAnswersPlaceholder: "Write your answers here.",
          saveAnswers: "Save Answers",
          resumeIntake: "Resume Intake",
          pauseProject: "Pause Project",
          runTick: "Run Tick",
          taskList: "Task List",
          recentEvents: "Recent Events",
          latestLog: "Latest Log Tail",
          review: "Review",
          continueAfterReview: "Continue After Review",
          reviewContent: "Review Content",
          noLogs: "No logs.",
          reviewHintNone: "No review pending.",
          reviewHintNeed: "Review required: click a file to preview. When done, click continue.",
          stateLabel: "State",
          tasksLabel: "Tasks",
          diagnosisLabel: "Diagnosis",
          lastUpdated: "Last update",
          interactionState: "State",
          reviewSelectPrompt: "Select a file to preview.",
          statusTodo: "Todo",
          statusDone: "Done",
          statusBlocked: "Blocked",
          statusFailed: "Failed",
        },
      };

      function t(key) {
        return (LANG[currentLang] && LANG[currentLang][key]) || key;
      }

      function isPlaceholderText(text, key) {
        const value = (text || "").trim();
        return Object.keys(LANG).some((lang) => {
          return (LANG[lang] && LANG[lang][key] && LANG[lang][key].trim() === value);
        });
      }

      function applyLanguage(lang) {
        currentLang = LANG[lang] ? lang : "zh";
        document.documentElement.lang = currentLang;
        languageSelect.value = currentLang;
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          el.textContent = t(key);
        });
        document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
          const key = el.getAttribute("data-i18n-placeholder");
          el.setAttribute("placeholder", t(key));
        });
        if (isPlaceholderText(logBox.textContent, "noLogs")) {
          logBox.textContent = t("noLogs");
        }
        if (isPlaceholderText(reviewContent.textContent, "reviewSelectPrompt")) {
          reviewContent.textContent = t("reviewSelectPrompt");
        }
        const isStatePlaceholder = isPlaceholderText(interactionState.textContent, "interactionState");
        if (isStatePlaceholder || interactionState.textContent.includes(":")) {
          interactionState.textContent = `${t("interactionState")}: ${interactionState.textContent.split(":").pop().trim() || "--"}`;
        }
        updateTimestamp();
      }

      function secondsToHuman(seconds) {
        if (seconds === null || seconds === undefined) return "--";
        if (Number.isNaN(seconds)) return "--";
        if (seconds < 0) return "--";
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        if (mins === 0) return `${secs}s`;
        return `${mins}m ${secs}s`;
      }

      function updateTimestamp() {
        const now = new Date();
        lastUpdated.textContent = `${t("lastUpdated")}: ${now.toLocaleTimeString()}`;
      }

      function setActiveTab(tabId) {
        tabs.forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === tabId);
        });
        tabPanels.forEach((panel) => {
          panel.classList.toggle("active", panel.id === tabId);
        });
      }

      async function fetchJSON(path) {
        const res = await fetch(path);
        if (!res.ok) throw new Error(`Request failed: ${res.status}`);
        return res.json();
      }

      async function postJSON(path, payload) {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {}),
        });
        if (!res.ok) throw new Error(`Request failed: ${res.status}`);
        return res.json();
      }

      async function loadProjects() {
        const data = await fetchJSON("/api/projects");
        projectListEl.innerHTML = "";
        data.projects.forEach((name) => {
          const btn = document.createElement("div");
          btn.className = "project" + (name === currentProject ? " active" : "");
          btn.textContent = name;
          btn.onclick = () => selectProject(name);
          projectListEl.appendChild(btn);
        });
        if (!currentProject && data.projects.length > 0) {
          selectProject(data.projects[0]);
        }
      }

      async function selectProject(name) {
        currentProject = name;
        await refreshAll();
        await loadProjects();
      }

      async function refreshAll(forceLogs = false) {
        if (!currentProject) return;
        const [state, tasks, logs, eventsData, intakeData, reviewData, interactionData] = await Promise.all([
          fetchJSON(`/api/projects/${currentProject}/state`),
          fetchJSON(`/api/projects/${currentProject}/tasks`),
          fetchJSON(`/api/projects/${currentProject}/logs?tail=200`),
          fetchJSON(`/api/projects/${currentProject}/events?tail=50`),
          fetchJSON(`/api/projects/${currentProject}/intake`),
          fetchJSON(`/api/projects/${currentProject}/review`),
          fetchJSON(`/api/projects/${currentProject}/interaction`),
        ]);

        const now = Math.floor(Date.now() / 1000);
        const runtime = state.started_at ? now - state.started_at : null;
        const heartbeat = state.heartbeat_at ? now - state.heartbeat_at : null;

        stateValue.textContent = state.state || "--";
        roleValue.textContent = state.role || "--";
        runtimeValue.textContent = secondsToHuman(runtime);
        heartbeatValue.textContent = secondsToHuman(heartbeat);
        taskBadge.textContent = `${t("tasksLabel")}: ${tasks.done}/${tasks.total}`;
        diagnosisBadge.textContent = `${t("diagnosisLabel")}: ${state.diagnosis || "n/a"}`;

        taskList.innerHTML = "";
        const events = eventsData.events || [];
        const items = tasks.items || [];
        let lastDoneIndex = -1;
        let currentTaskId = null;
        items.forEach((task, idx) => {
          const status = (task.status || "").toLowerCase();
          if (status === "done") {
            lastDoneIndex = idx;
          } else if (!currentTaskId) {
            currentTaskId = task.id || null;
          }
        });
        if (!currentTaskId && lastDoneIndex >= 0) {
          currentTaskId = items[lastDoneIndex].id || null;
        }
        const startIndex = Math.max(0, lastDoneIndex - 3);
        const visibleTasks = items.slice(startIndex);
        visibleTasks.forEach((task) => {
          const statusRaw = (task.status || "").toLowerCase();
          let statusClass = "todo";
          let statusLabel = t("statusTodo");
          if (statusRaw === "done") {
            statusClass = "done";
            statusLabel = t("statusDone");
          } else if (statusRaw === "blocked") {
            statusClass = "blocked";
            statusLabel = t("statusBlocked");
          } else if (statusRaw === "failed" || statusRaw === "error" || statusRaw === "broke") {
            statusClass = "failed";
            statusLabel = t("statusFailed");
          }
          const row = document.createElement("div");
          row.className = `task ${statusClass}`;
          const left = document.createElement("div");
          left.className = "left";
          const icon = document.createElement("span");
          icon.className = "icon";
          const name = document.createElement("div");
          name.className = "name";
          name.textContent = `${task.id || "-"}: ${task.title || ""}`;
          left.appendChild(icon);
          left.appendChild(name);
          row.appendChild(left);
          taskList.appendChild(row);
        });

        if (events.length > 0) {
          const successes = events.filter((e) => e.exit_code === 0).length;
          const rate = Math.round((successes / events.length) * 100);
          successValue.textContent = `${rate}%`;
        } else {
          successValue.textContent = "--";
        }

        if (eventList) {
          eventList.innerHTML = "";
        }

        const rawQuestions = intakeData.questions || "";
        let fallbackQuestions = "";
        if (!rawQuestions && intakeData.answers) {
          const parts = intakeData.answers.split("# Open Questions");
          if (parts.length > 1) {
            fallbackQuestions = "# Open Questions" + parts[1];
          }
        }
        intakeQuestions.value = rawQuestions || fallbackQuestions || "";
        const isFocused = document.activeElement === intakeAnswers;
        if (!intakeDirty && !isFocused && intakeData.answers !== undefined) {
          intakeAnswers.value = intakeData.answers || "";
        }

        interactionState.textContent = `${t("interactionState")}: ${interactionData.state || "--"}`;
        interactiveModeToggle.checked = !!interactionData.interactive_mode;
        const interactionFocused = document.activeElement === interactionNotes;
        if (!interactionDirty && !interactionFocused) {
          interactionNotes.value = interactionData.notes || "";
        }

        reviewList.innerHTML = "";
        if (reviewData.state === "REVIEW_READY" && reviewData.items && reviewData.items.length > 0) {
          reviewHint.textContent = t("reviewHintNeed");
          continueAfterReviewBtn.disabled = false;
          reviewData.items.forEach((item) => {
            const row = document.createElement("div");
            row.className = "task";
            const name = document.createElement("div");
            name.className = "name";
            name.textContent = item;
            name.style.cursor = "pointer";
            name.onclick = async () => {
              const data = await fetchJSON(
                `/api/projects/${currentProject}/file?path=${encodeURIComponent(item)}`
              );
              reviewContent.textContent = data.content || "";
            };
            const status = document.createElement("div");
            status.className = "status";
            status.textContent = "open";
            row.appendChild(name);
            row.appendChild(status);
            reviewList.appendChild(row);
          });
        } else {
          reviewHint.textContent = t("reviewHintNone");
          continueAfterReviewBtn.disabled = true;
          if (isPlaceholderText(reviewContent.textContent, "reviewSelectPrompt")) {
            reviewContent.textContent = t("reviewSelectPrompt");
          }
        }

        const logKey = `${logs.file || "none"}:${logs.mtime || 0}:${logs.size || 0}`;
        if (forceLogs || logKey !== lastLogKey) {
          lastLogKey = logKey;
          if (logs.lines && logs.lines.length > 0) {
            logBox.textContent = logs.lines.join("\n");
            if (followLogs.checked) {
              logBox.scrollTop = logBox.scrollHeight;
            }
          } else {
            logBox.textContent = t("noLogs");
          }
        }
        updateTimestamp();
      }

      intakeAnswers.addEventListener("input", () => {
        intakeDirty = true;
      });

      interactionNotes.addEventListener("input", () => {
        interactionDirty = true;
      });
      interactiveModeToggle.addEventListener("change", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/interaction`, {
          notes: interactionNotes.value || "",
          interactive_mode: interactiveModeToggle.checked,
        });
        interactionDirty = false;
        if (!interactiveModeToggle.checked) {
          await postJSON(`/api/projects/${currentProject}/run`, {});
        }
        await refreshAll();
      });

      saveIntakeBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/intake`, {
          answers: intakeAnswers.value || "",
        });
        intakeDirty = false;
        await refreshAll();
      });

      pauseBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/pause`, {});
        await refreshAll();
      });

      resumeBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/resume`, {});
        await postJSON(`/api/projects/${currentProject}/run`, {});
        await refreshAll();
      });

      runBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/run`, {});
        await refreshAll();
      });

      saveInteractionBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/interaction`, {
          notes: interactionNotes.value || "",
          interactive_mode: interactiveModeToggle.checked,
        });
        interactionDirty = false;
        await refreshAll();
      });

      interruptBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/interaction/pause`, {});
        await refreshAll();
      });

      continueBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/interaction/continue`, {});
        await postJSON(`/api/projects/${currentProject}/run`, {});
        await refreshAll();
      });

      continueAfterReviewBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/review/continue`, {});
        await postJSON(`/api/projects/${currentProject}/run`, {});
        await refreshAll();
      });

      refreshBtn.addEventListener("click", refreshAll);
      languageSelect.addEventListener("change", () => {
        const lang = languageSelect.value || "zh";
        localStorage.setItem("dashboardLang", lang);
        applyLanguage(lang);
        refreshAll(true);
      });
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          setActiveTab(tab.dataset.tab);
        });
      });

      async function start() {
        const storedLang = localStorage.getItem("dashboardLang") || "zh";
        applyLanguage(storedLang);
        await loadProjects();
        if (timer) clearInterval(timer);
        timer = setInterval(() => refreshAll(false), 2000);
      }

      start().catch((err) => {
        logBox.textContent = `Error: ${err.message}`;
      });
    </script>
  </body>
</html>
