<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AutoCodex Dashboard</title>
    <style>
      :root {
        --bg: #0f1411;
        --panel: #151c18;
        --panel-2: #1b241f;
        --ink: #e7f4e9;
        --muted: #b4c4b8;
        --accent: #7be0a4;
        --accent-2: #f6b26b;
        --warning: #f08a5d;
        --border: #2a342f;
        --shadow: rgba(8, 12, 10, 0.5);
        --radius: 16px;
        --mono: "JetBrains Mono", "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
        --sans: "Space Grotesk", "IBM Plex Sans", "Manrope", "Segoe UI", sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--ink);
        background:
          radial-gradient(circle at 15% 15%, rgba(123, 224, 164, 0.12), transparent 40%),
          radial-gradient(circle at 85% 10%, rgba(246, 178, 107, 0.16), transparent 35%),
          linear-gradient(180deg, #0c110e 0%, #111714 55%, #0c110e 100%);
        min-height: 100vh;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 32px 8px;
      }

      .title {
        font-size: 28px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .subtitle {
        color: var(--muted);
        font-size: 14px;
        margin-top: 4px;
      }

      .shell {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 20px;
        padding: 0 32px 32px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: 0 12px 30px var(--shadow);
      }

      .side {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .side h3 {
        margin: 0;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--muted);
      }

      .project-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .project {
        padding: 10px 12px;
        border-radius: 12px;
        background: var(--panel-2);
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .project.active {
        border-color: var(--accent);
        box-shadow: inset 0 0 0 1px rgba(123, 224, 164, 0.4);
      }

      .project:hover {
        border-color: rgba(123, 224, 164, 0.5);
      }

      .main {
        padding: 16px;
        display: grid;
        grid-template-rows: auto auto 1fr;
        gap: 16px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(5, minmax(140px, 1fr));
        gap: 12px;
      }

      .card {
        padding: 14px;
        background: var(--panel-2);
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .card h4 {
        margin: 0 0 8px;
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .card .value {
        font-size: 20px;
        font-weight: 600;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(123, 224, 164, 0.16);
        color: var(--accent);
        font-size: 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 16px;
      }

      .stack {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .section {
        padding: 16px;
        background: var(--panel-2);
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .section h3 {
        margin: 0 0 12px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--muted);
      }

      .intake-box {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .intake-box textarea {
        width: 100%;
        min-height: 140px;
        background: #0d120f;
        color: var(--ink);
        border: 1px solid rgba(42, 52, 47, 0.9);
        border-radius: 10px;
        padding: 10px;
        font-family: var(--mono);
        font-size: 12px;
        line-height: 1.5;
      }

      #interactionNotes {
        width: 100%;
        min-height: 140px;
        background: #0d120f;
        color: var(--ink);
        border: 1px solid rgba(42, 52, 47, 0.9);
        border-radius: 10px;
        padding: 10px;
        font-family: var(--mono);
        font-size: 12px;
        line-height: 1.5;
      }

      .intake-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .tasks {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 260px;
        overflow: auto;
        padding-right: 4px;
      }

      .task {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(15, 20, 17, 0.6);
        border: 1px solid rgba(42, 52, 47, 0.8);
      }

      .task .name {
        font-size: 13px;
      }

      .task .status {
        font-size: 12px;
        color: var(--muted);
      }

      .log {
        font-family: var(--mono);
        font-size: 12px;
        line-height: 1.5;
        background: #0d120f;
        border-radius: 12px;
        border: 1px solid rgba(42, 52, 47, 0.9);
        padding: 12px;
        height: 320px;
        overflow: auto;
        white-space: pre-wrap;
      }

      .review-content {
        font-family: var(--mono);
        font-size: 12px;
        line-height: 1.5;
        background: #0d120f;
        border-radius: 12px;
        border: 1px solid rgba(42, 52, 47, 0.9);
        padding: 12px;
        height: 220px;
        overflow: auto;
        white-space: pre-wrap;
      }

      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 12px;
        color: var(--muted);
      }

      .btn {
        background: var(--accent);
        color: #0b120e;
        border: none;
        padding: 8px 12px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn.alt {
        background: transparent;
        color: var(--ink);
        border: 1px solid var(--border);
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      @media (max-width: 900px) {
        .shell {
          grid-template-columns: 1fr;
        }
        .cards {
          grid-template-columns: repeat(2, minmax(140px, 1fr));
        }
        .grid {
          grid-template-columns: 1fr;
        }
        .intake-box {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <div class="title">AutoCodex Monitor</div>
        <div class="subtitle">Local project status, tasks, and logs in one view.</div>
      </div>
      <div class="controls">
        <span id="lastUpdated">Last update: --</span>
        <label class="toggle">
          <input type="checkbox" id="followLogs" checked />
          Follow logs
        </label>
        <button class="btn alt" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <div class="shell">
      <aside class="panel side">
        <h3>Projects</h3>
        <div id="projectList" class="project-list"></div>
      </aside>

      <main class="panel main">
        <div class="cards">
          <div class="card">
            <h4>State</h4>
            <div class="value" id="stateValue">--</div>
          </div>
          <div class="card">
            <h4>Role</h4>
            <div class="value" id="roleValue">--</div>
          </div>
          <div class="card">
            <h4>Runtime</h4>
            <div class="value" id="runtimeValue">--</div>
          </div>
          <div class="card">
            <h4>Heartbeat Age</h4>
            <div class="value" id="heartbeatValue">--</div>
          </div>
          <div class="card">
            <h4>Success Rate</h4>
            <div class="value" id="successValue">--</div>
          </div>
        </div>

        <div class="section">
          <div class="badge" id="taskBadge">Tasks: --</div>
          <div class="badge" id="diagnosisBadge">Diagnosis: --</div>
        </div>

        <div class="section">
          <h3>Intake</h3>
          <div class="intake-box">
            <textarea id="intakeQuestions" readonly placeholder="Questions will appear here."></textarea>
            <textarea id="intakeAnswers" placeholder="Write your answers here."></textarea>
          </div>
          <div class="intake-actions">
            <button class="btn" id="saveIntakeBtn">Save Answers</button>
            <button class="btn alt" id="resumeBtn">Resume Intake</button>
            <button class="btn alt" id="pauseBtn">Pause Project</button>
            <button class="btn alt" id="runBtn">Run Tick</button>
          </div>
        </div>

        <div class="section">
          <h3>Interaction</h3>
          <div class="controls" style="margin-bottom: 8px;">
            <label class="toggle">
              <input type="checkbox" id="interactiveModeToggle" />
              Interactive Mode
            </label>
            <span id="interactionState">State: --</span>
          </div>
          <textarea id="interactionNotes" placeholder="Type notes for the agent here."></textarea>
          <div class="intake-actions">
            <button class="btn" id="saveInteractionBtn">Save Notes</button>
            <button class="btn alt" id="interruptBtn">Interrupt Now</button>
            <button class="btn alt" id="continueBtn">Continue</button>
          </div>
        </div>

        <div class="section">
          <h3>Review</h3>
          <div class="subtitle" id="reviewHint">No review pending.</div>
          <div class="tasks" id="reviewList"></div>
          <div class="intake-actions">
            <button class="btn alt" id="continueAfterReviewBtn">Continue After Review</button>
          </div>
        </div>

        <div class="grid">
          <div class="stack">
            <div class="section">
              <h3>Task List</h3>
              <div class="tasks" id="taskList"></div>
            </div>
            <div class="section">
              <h3>Recent Events</h3>
              <div class="tasks" id="eventList"></div>
            </div>
            <div class="section">
              <h3>Review Content</h3>
              <div class="review-content" id="reviewContent">Select a file to preview.</div>
            </div>
          </div>
          <div class="section">
            <h3>Latest Log Tail</h3>
            <div class="log" id="logBox">No logs.</div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const projectListEl = document.getElementById("projectList");
      const stateValue = document.getElementById("stateValue");
      const roleValue = document.getElementById("roleValue");
      const runtimeValue = document.getElementById("runtimeValue");
      const heartbeatValue = document.getElementById("heartbeatValue");
      const taskBadge = document.getElementById("taskBadge");
      const diagnosisBadge = document.getElementById("diagnosisBadge");
      const taskList = document.getElementById("taskList");
      const eventList = document.getElementById("eventList");
      const logBox = document.getElementById("logBox");
      const lastUpdated = document.getElementById("lastUpdated");
      const refreshBtn = document.getElementById("refreshBtn");
      const successValue = document.getElementById("successValue");
      const intakeQuestions = document.getElementById("intakeQuestions");
      const intakeAnswers = document.getElementById("intakeAnswers");
      const saveIntakeBtn = document.getElementById("saveIntakeBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const resumeBtn = document.getElementById("resumeBtn");
      const runBtn = document.getElementById("runBtn");
      const followLogs = document.getElementById("followLogs");
      const reviewList = document.getElementById("reviewList");
      const reviewHint = document.getElementById("reviewHint");
      const continueAfterReviewBtn = document.getElementById("continueAfterReviewBtn");
      const reviewContent = document.getElementById("reviewContent");
      const interactionNotes = document.getElementById("interactionNotes");
      const interactiveModeToggle = document.getElementById("interactiveModeToggle");
      const saveInteractionBtn = document.getElementById("saveInteractionBtn");
      const interruptBtn = document.getElementById("interruptBtn");
      const continueBtn = document.getElementById("continueBtn");
      const interactionState = document.getElementById("interactionState");

      let currentProject = null;
      let timer = null;
      let intakeDirty = false;
      let interactionDirty = false;
      let lastLogKey = "";

      function secondsToHuman(seconds) {
        if (seconds === null || seconds === undefined) return "--";
        if (Number.isNaN(seconds)) return "--";
        if (seconds < 0) return "--";
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        if (mins === 0) return `${secs}s`;
        return `${mins}m ${secs}s`;
      }

      function updateTimestamp() {
        const now = new Date();
        lastUpdated.textContent = `Last update: ${now.toLocaleTimeString()}`;
      }

      async function fetchJSON(path) {
        const res = await fetch(path);
        if (!res.ok) throw new Error(`Request failed: ${res.status}`);
        return res.json();
      }

      async function postJSON(path, payload) {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {}),
        });
        if (!res.ok) throw new Error(`Request failed: ${res.status}`);
        return res.json();
      }

      async function loadProjects() {
        const data = await fetchJSON("/api/projects");
        projectListEl.innerHTML = "";
        data.projects.forEach((name) => {
          const btn = document.createElement("div");
          btn.className = "project" + (name === currentProject ? " active" : "");
          btn.textContent = name;
          btn.onclick = () => selectProject(name);
          projectListEl.appendChild(btn);
        });
        if (!currentProject && data.projects.length > 0) {
          selectProject(data.projects[0]);
        }
      }

      async function selectProject(name) {
        currentProject = name;
        await refreshAll();
        await loadProjects();
      }

      async function refreshAll(forceLogs = false) {
        if (!currentProject) return;
        const [state, tasks, logs, eventsData, intakeData, reviewData, interactionData] = await Promise.all([
          fetchJSON(`/api/projects/${currentProject}/state`),
          fetchJSON(`/api/projects/${currentProject}/tasks`),
          fetchJSON(`/api/projects/${currentProject}/logs?tail=200`),
          fetchJSON(`/api/projects/${currentProject}/events?tail=50`),
          fetchJSON(`/api/projects/${currentProject}/intake`),
          fetchJSON(`/api/projects/${currentProject}/review`),
          fetchJSON(`/api/projects/${currentProject}/interaction`),
        ]);

        const now = Math.floor(Date.now() / 1000);
        const runtime = state.started_at ? now - state.started_at : null;
        const heartbeat = state.heartbeat_at ? now - state.heartbeat_at : null;

        stateValue.textContent = state.state || "--";
        roleValue.textContent = state.role || "--";
        runtimeValue.textContent = secondsToHuman(runtime);
        heartbeatValue.textContent = secondsToHuman(heartbeat);
        taskBadge.textContent = `Tasks: ${tasks.done}/${tasks.total}`;
        diagnosisBadge.textContent = `Diagnosis: ${state.diagnosis || "n/a"}`;

        taskList.innerHTML = "";
        tasks.items.forEach((task) => {
          const row = document.createElement("div");
          row.className = "task";
          const name = document.createElement("div");
          name.className = "name";
          name.textContent = `${task.id || "-"}: ${task.title || ""}`;
          const status = document.createElement("div");
          status.className = "status";
          status.textContent = task.status || "--";
          row.appendChild(name);
          row.appendChild(status);
          taskList.appendChild(row);
        });

        const events = eventsData.events || [];
        if (events.length > 0) {
          const successes = events.filter((e) => e.exit_code === 0).length;
          const rate = Math.round((successes / events.length) * 100);
          successValue.textContent = `${rate}%`;
        } else {
          successValue.textContent = "--";
        }

        eventList.innerHTML = "";
        events.slice().reverse().forEach((evt) => {
          const row = document.createElement("div");
          row.className = "task";
          const name = document.createElement("div");
          name.className = "name";
          const ts = evt.ts ? new Date(evt.ts * 1000).toLocaleTimeString() : "--";
          name.textContent = `${ts} ${evt.role || ""} ${evt.state_before || ""} -> ${evt.state_after || ""}`;
          const status = document.createElement("div");
          status.className = "status";
          status.textContent = evt.exit_code === 0 ? "ok" : `exit ${evt.exit_code}`;
          row.appendChild(name);
          row.appendChild(status);
          eventList.appendChild(row);
        });

        const rawQuestions = intakeData.questions || "";
        let fallbackQuestions = "";
        if (!rawQuestions && intakeData.answers) {
          const parts = intakeData.answers.split("# Open Questions");
          if (parts.length > 1) {
            fallbackQuestions = "# Open Questions" + parts[1];
          }
        }
        intakeQuestions.value = rawQuestions || fallbackQuestions || "";
        const isFocused = document.activeElement === intakeAnswers;
        if (!intakeDirty && !isFocused && intakeData.answers !== undefined) {
          intakeAnswers.value = intakeData.answers || "";
        }

        interactionState.textContent = `State: ${interactionData.state || "--"}`;
        interactiveModeToggle.checked = !!interactionData.interactive_mode;
        const interactionFocused = document.activeElement === interactionNotes;
        if (!interactionDirty && !interactionFocused) {
          interactionNotes.value = interactionData.notes || "";
        }

        reviewList.innerHTML = "";
        if (reviewData.state === "REVIEW_READY" && reviewData.items && reviewData.items.length > 0) {
          reviewHint.textContent =
            "Review required: click a file to preview. When done, click Run Tick to continue.";
          continueAfterReviewBtn.disabled = false;
          reviewData.items.forEach((item) => {
            const row = document.createElement("div");
            row.className = "task";
            const name = document.createElement("div");
            name.className = "name";
            name.textContent = item;
            name.style.cursor = "pointer";
            name.onclick = async () => {
              const data = await fetchJSON(
                `/api/projects/${currentProject}/file?path=${encodeURIComponent(item)}`
              );
              reviewContent.textContent = data.content || "";
            };
            const status = document.createElement("div");
            status.className = "status";
            status.textContent = "open";
            row.appendChild(name);
            row.appendChild(status);
            reviewList.appendChild(row);
          });
        } else {
          reviewHint.textContent = "No review pending.";
          continueAfterReviewBtn.disabled = true;
        }

        const logKey = `${logs.file || "none"}:${logs.mtime || 0}:${logs.size || 0}`;
        if (forceLogs || logKey !== lastLogKey) {
          lastLogKey = logKey;
          if (logs.lines && logs.lines.length > 0) {
            logBox.textContent = logs.lines.join("\n");
            if (followLogs.checked) {
              logBox.scrollTop = logBox.scrollHeight;
            }
          } else {
            logBox.textContent = "No logs.";
          }
        }
        updateTimestamp();
      }

      intakeAnswers.addEventListener("input", () => {
        intakeDirty = true;
      });

      interactionNotes.addEventListener("input", () => {
        interactionDirty = true;
      });
      interactiveModeToggle.addEventListener("change", () => {
        interactionDirty = true;
      });

      saveIntakeBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/intake`, {
          answers: intakeAnswers.value || "",
        });
        intakeDirty = false;
        await refreshAll();
      });

      pauseBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/pause`, {});
        await refreshAll();
      });

      resumeBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/resume`, {});
        await postJSON(`/api/projects/${currentProject}/run`, {});
        await refreshAll();
      });

      runBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/run`, {});
        await refreshAll();
      });

      saveInteractionBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/interaction`, {
          notes: interactionNotes.value || "",
          interactive_mode: interactiveModeToggle.checked,
        });
        interactionDirty = false;
        await refreshAll();
      });

      interruptBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/interaction/pause`, {});
        await refreshAll();
      });

      continueBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/interaction/continue`, {});
        await postJSON(`/api/projects/${currentProject}/run`, {});
        await refreshAll();
      });

      continueAfterReviewBtn.addEventListener("click", async () => {
        if (!currentProject) return;
        await postJSON(`/api/projects/${currentProject}/review/continue`, {});
        await postJSON(`/api/projects/${currentProject}/run`, {});
        await refreshAll();
      });

      refreshBtn.addEventListener("click", refreshAll);

      async function start() {
        await loadProjects();
        if (timer) clearInterval(timer);
        timer = setInterval(() => refreshAll(false), 2000);
      }

      start().catch((err) => {
        logBox.textContent = `Error: ${err.message}`;
      });
    </script>
  </body>
</html>
